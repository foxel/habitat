<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">

    <title>Habitat World Observer</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="./libs/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="./libs/bootstrap/css/bootstrap-responsive.css" rel="stylesheet">

    <!-- <link rel="shortcut icon" href="/favicon.png"> -->
    <link href="./css/default.css" rel="stylesheet">
    <link href="./theme/default/map.css" rel="stylesheet" />

    <script src="./libs/require/require.js" type="text/javascript"></script>
    <script src="./js/require.cfg.js" type="text/javascript"></script>

    <script type="text/template" id="template-map">
        <div class="tiled-map"><%
            var tt, tl, x, y = 0;
            _.each(data.map, function(row) {
                x = 0;
                %><div class="tiles-row"><%
                _.each(row, function(tile) {
                    var tr = trans(data.map, x, y);
                    %><div class="tile tile-<%= tile %>" id="tile-<%= x %>x<%= y %>"><%
                    for(tt = 0, tl = tr.length; tt < tl; tt++) {
                        if (tr[tt]) {
                            if(tr[tt][0]) {
                                %><div class="tile-transition side-<%= tile %>-<%= tt %>-<%= tr[tt][0] %>"></div><%
                            }
                            if(tr[tt][1]) {
                                %><div class="tile-transition corner-<%= tile %>-<%= tt %>-<%= tr[tt][1] %>"></div><%
                            }
                        }
                    }
                    %></div><%
                    x++;
                })
                %></div><%
                y++;
            })
        %></div>
    </script>
    <script type="text/template" id="template-mob">
        <div class="mob model-<%= o.id %>" title="<%= o.name%> by <%= o.author %>"><div class="name"><%= o.name %> (<%= o.id %>)</div><div class="status">[<%-o.health%>/<%-o.satiety%>]</div></div>
    </script>
    <script type="text/template" id="template-object">
        <div class="object model-<%= o.class %>-<%= (o.x + o.y) % 5 %>"></div>
    </script>
    <script src="./libs/underscore/underscore.js" type="text/javascript"></script>
    <script src="./libs/jquery/jquery-1.10.2.js" type="text/javascript"></script>
    <script type="text/javascript">
        var mapData = {
            map : [
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0],
                [0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 5, 1, 1, 1, 1, 5, 5, 5, 5, 5, 1, 0],
                [0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 5, 1, 1, 1, 1, 1, 1, 1, 1, 5, 1, 0],
                [0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 5, 1, 1, 1, 1, 1, 1, 1, 1, 5, 1, 0],
                [0, 1, 1, 1, 1, 4, 4, 1, 1, 1, 1, 5, 5, 5, 5, 5, 5, 1, 1, 1, 1, 5, 1, 0],
                [0, 1, 1, 1, 4, 4, 4, 4, 1, 1, 5, 5, 5, 1, 1, 1, 1, 1, 1, 1, 5, 5, 1, 0],
                [0, 1, 1, 4, 4, 4, 4, 4, 4, 1, 5, 5, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0],
                [0, 1, 1, 4, 4, 5, 5, 4, 4, 1, 5, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0],
                [0, 1, 1, 4, 4, 4, 4, 4, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0],
                [0, 1, 1, 1, 4, 4, 4, 1, 1, 1, 1, 1, 1, 1, 1, 5, 5, 5, 1, 1, 1, 1, 1, 0],
                [0, 1, 1, 1, 4, 4, 4, 1, 1, 1, 1, 1, 1, 1, 1, 5, 5, 5, 1, 1, 1, 1, 1, 0],
                [0, 1, 1, 1, 1, 4, 4, 1, 1, 1, 1, 1, 1, 1, 1, 5, 5, 5, 1, 1, 1, 1, 1, 0],
                [1, 1, 1, 1, 1, 4, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
                [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 5, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
                [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 5, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
                [0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 5, 1, 1, 1, 1, 1, 1, 1, 5, 1, 1, 1, 0],
                [0, 1, 1, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0],
                [0, 1, 1, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0],
                [0, 1, 1, 2, 2, 2, 1, 1, 1, 1, 1, 5, 1, 1, 1, 1, 5, 1, 1, 1, 1, 1, 1, 0],
                [0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 5, 5, 5, 1, 1, 1, 1, 1, 1, 1, 3, 1, 1, 0],
                [0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 5, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0],
                [0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            ]
        };
        function drawMap(data) {
            var templateMap = _.template($('#template-map').html());
            var map = $('#map');
            var tMap = {
                s : [[0, -1], [1, 0], [0, 1], [-1, 0]],
                c : [
                    [ 1, -1,  3],
                    [ 1,  1,  6],
                    [-1,  1, 12],
                    [-1, -1,  9]
                ]
            };
            map.html(templateMap({
                data: data,
                trans: function(map, x, y) {
                    var
                        my = map.length - 1,
                        mx = my >= 0 ? map[0].length - 1 : 0,
                        r = [],
                        dx, dy, nx, ny, b, ct, nt, i, l, m;
                    for(i = 0, l = tMap.s.length; i < l; i++) {
                        dx = tMap.s[i][0];
                        dy = tMap.s[i][1];
                        nx = (x + dx > mx ? 0 : (x + dx < 0 ? mx : x + dx));
                        ny = (y + dy > my ? 0 : (y + dy < 0 ? my : y + dy));
                        b = 1 << i;
                        ct = map[y][x];
                        nt = map[ny][nx];
                        if (ct != nt) {
                            if (r[nt]) {
                                r[nt][0] = r[nt][0] | b;
                            } else {
                                r[nt] = [b, 0];
                            }
                        }
                    }
                    for(i = 0, l = tMap.c.length; i< l; i++) {
                        dx = tMap.c[i][0];
                        dy = tMap.c[i][1];
                        m = tMap.c[i][2];
                        nx = (x + dx > mx ? 0 : (x + dx < 0 ? mx : x + dx));
                        ny = (y + dy > my ? 0 : (y + dy < 0 ? my : y + dy));
                        b = 1 << i;
                        ct = map[y][x];
                        nt = map[ny][nx];
                        if (ct != nt) {
                            if (r[nt]) {
                                if ((r[nt][0] & m) == 0) {
                                    r[nt][1] = r[nt][1] | b;
                                }
                            } else {
                                r[nt] = [0, b];
                            }
                        }
                    }
                    return r;
                }
            }));
        }
        $(document).ready(function(){
            drawMap(mapData);
        });
    </script>

</head>

<body>
<div id="sideBar"></div>
<div id="mapViewport"><div id="map"></div>
</body>
</html>
